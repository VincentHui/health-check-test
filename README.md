[![CircleCI](https://dl.circleci.com/status-badge/img/gh/VincentHui/health-check-test/tree/main.svg?style=svg)](https://dl.circleci.com/status-badge/redirect/gh/VincentHui/health-check-test/tree/main)

# heartbeat-test service

This is a TypeScript Node.js application uses the [ubio node-framework](https://github.com/ubio/node-framework) to structure the application and use inversion of control (IoC) via mesh to manage dependencies. Redis is used for the noSQL DB logic and an in memory reddis server is used for both quick setup and for jest tests.

A number of different client applications will periodically send heartbeats to this service, and the service keeps track of them, periodically removing those that didn't send any heartbeats based on the variable MAX_HEARTBEAT_AGE in the .env file. The default is currently set to 60000 ms or one minute.

## Installation

1. Clone this repository to your local machine.
2. Navigate to the project directory in your terminal or command prompt.
3. Run `npm install` to install the dependencies.
4. Run `npm run compile && npm run start` to both compile the typescript files and then run the application.
5. Run `npm run compile && npm run test` to both compile the typescript files and then run the tests.

## Application Structure

```
src/                                    // TypeScript sources
    bin/                                // Runnable entrypoints
        serve.ts                        // Start application HTTP server
    main/
        routes/                         // The functionality exposed by the application via HTTP
        repositories/                   // Storage abstraction layer
            redisRepo.ts
        services/                       // Business logic abstraction layere
            heartbeatCheckService.ts
            reddisServer.ts
        schema/                         // Domain model data structures
            instance.ts
        app.ts                          // Application class (IoC composition root)
    test/
out/                                    // Compiled output (.js and .d.ts files)
    main/
    test/
```

## Using the Service

Once the health check service is running, you can access it using a API tool like postman. The service provides the following endpoints:

- `POST /:group/:id`

  - registers an application instance in specified `group`
  - `id` is a unique identifier of application instance, generated by client
  - if instance is already registered, the `updatedAt` timestamp must be updated
  - the request body can specify meta information that will be attached to the instance
  - returns JSON with following structure:

    ```js
    {
        "id": "e335175a-eace-4a74-b99c-c6466b6afadd",   // echoed from path parameter
        "group": "particle-detector",                   // echoed from path parameter
        "createdAt": 1571418096158,                     // first registered heartbeat
        "updatedAt": 1571418124127,                     // last registered heartbeat
        "meta": {                                       // meta echoed from request body
            "foo": 1
        }
    }
    ```

- `DELETE /:group/:id`

  - unregisters an application instance

- `GET /`

  - returns a JSON array containing a summary of all currently registered groups as follows:

    ```js
    [
      {
        group: "particle-detector",
        instances: "4", // the number of registered instances in this group
        createdAt: 1571418124127, // first heartbeat registered in this group
        lastUpdatedAt: 1571418124127, // last heartbeat registered in this group
      },
      // ...
    ];
    ```

  - groups containing 0 instances should not be returned

- `GET /:group`

  - returns a JSON array describing instances of the `group`:

    ```js
    [
      {
        id: "e335175a-eace-4a74-b99c-c6466b6afadd",
        group: "particle-detector",
        createdAt: 1571418096158,
        updatedAt: 1571418124127,
        meta: {
          foo: 1,
        },
      },
      // ...
    ];
    ```

## Implementation notes

- The ubio schema was not used although the structure and convention are used. The ubio schema wasn't used because it cannot use an object with the anyOf pattern properties for the meta object.
- Although I used a redis client to make the needed commands to create the needed structure I would probably use a ORM for redis if I attempted this again. Also it seems pretty easy to head to redislabs to get a free tier redis db if you don't want to use the local reddis server. The connection url from redis labs would look something like this `` url: `redis://user:password@redis-10224.c78.eu-west-1-2.ec2.cloud.redislabs.com:10224`, ``
- Even though some typos on the ubio framework or mesh IOC deep dives might have delayed me longer it was honestly a great framework to use overall and has given me alot of ideas for some of my own projects.
